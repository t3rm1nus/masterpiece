<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Permissions-Policy" content="geolocation=*, camera=(), microphone=(), payment=*, accelerometer=*, gyroscope=*">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <title>Vite + React</title>

    <!-- Symbol.observable polyfill for Redux -->
    <script>
      (function() {
        if (typeof Symbol === 'undefined') {
          window.Symbol = {};
        }
        
        const $$observable = typeof Symbol === 'function' && Symbol.observable || '@@observable';
        
        if (!Symbol.observable) {
          Symbol.observable = $$observable;
        }
        
        if (typeof Symbol.observable === 'string') {
          Symbol.observable = Symbol.for ? Symbol.for(Symbol.observable) : $$observable;
        }
        
        console.log('‚úÖ Symbol.observable configurado:', Symbol.observable);
      })();
    </script>

    <!-- Environment Detection and PayPal SDK -->
    <script>
      // Detect environment
      window.isLocalhost = window.location.hostname === 'localhost' || 
                          window.location.hostname === '127.0.0.1' || 
                          window.location.port === '5173' ||
                          window.location.port === '3000';
      
      window.isProduction = !window.isLocalhost;
      
      console.log('üåç Environment:', {
        hostname: window.location.hostname,
        isLocalhost: window.isLocalhost,
        isProduction: window.isProduction
      });
        // Detect mobile device
      const isMobileDevice = window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      
      // Load PayPal SDK with mobile-optimized configuration      let sdkUrl;
      if (window.isLocalhost) {
        // En localhost, deshabilitar tarjetas para evitar errores de desarrollo
        sdkUrl = "https://www.paypal.com/sdk/js?client-id=AZDxjDScFpQtjWTOUtWKbyN_bDt4OgqaF4eYXlewfBP4-8aqX3PiV8e1GWU6liB2CUXlkA59kJXE7M6R&components=buttons&disable-funding=venmo,card&currency=EUR&debug=true";
      } else {
        // En producci√≥n, configuraci√≥n espec√≠fica por regi√≥n para EUR
        if (isMobileDevice) {
          // Configuraci√≥n m√≥vil con regi√≥n europea espec√≠fica para evitar DOMESTIC_TRANSACTION_REQUIRED
          sdkUrl = "https://www.paypal.com/sdk/js?client-id=AZDxjDScFpQtjWTOUtWKbyN_bDt4OgqaF4eYXlewfBP4-8aqX3PiV8e1GWU6liB2CUXlkA59kJXE7M6R&components=buttons&currency=EUR&locale=es_ES&disable-funding=venmo&intent=capture&buyer-country=ES";
        } else {
          // Configuraci√≥n desktop con regi√≥n europea
          sdkUrl = "https://www.paypal.com/sdk/js?client-id=AZDxjDScFpQtjWTOUtWKbyN_bDt4OgqaF4eYXlewfBP4-8aqX3PiV8e1GWU6liB2CUXlkA59kJXE7M6R&components=buttons&currency=EUR&locale=es_ES&disable-funding=venmo&buyer-country=ES";
        }
      }
        const script = document.createElement('script');
      script.src = sdkUrl;
      script.crossOrigin = 'anonymous';
      script.async = true;
      document.head.appendChild(script);
        console.log('üí≥ PayPal SDK loaded for:', {
        environment: window.isLocalhost ? 'localhost' : 'production',
        device: isMobileDevice ? 'm√≥vil' : 'desktop',
        cards: window.isLocalhost ? 'deshabilitadas (desarrollo)' : 'habilitadas',
        region: window.isLocalhost ? 'debug' : 'ES (Espa√±a)',
        currency: 'EUR',
        funding: 'PayPal + tarjetas (venmo deshabilitado)'
      });
    </script>    <!-- Geolocation Mock for Spain -->
    <script>
      (function() {
        console.log('üá™üá∏ Setting up geolocation mock for Spain...');
        
        // Enhanced geolocation mock with better Spain data
        const mockGeolocation = {
          getCurrentPosition: function(success, error, options) {
            console.log('üá™üá∏ Mock geolocation: Madrid, Spain (Europa)');
            if (success) {
              setTimeout(() => {
                success({
                  coords: {
                    latitude: 40.4168,      // Madrid
                    longitude: -3.7038,     // Madrid
                    altitude: 650,          // Madrid altitude
                    accuracy: 50,           // High accuracy
                    altitudeAccuracy: 10,
                    heading: null,
                    speed: null
                  },
                  timestamp: Date.now()
                });
              }, 50);
            }
          },
          watchPosition: function(success, error, options) {
            const id = Math.random();
            this.getCurrentPosition(success, error, options);
            return id;
          },
          clearWatch: function(id) {
            console.log('üá™üá∏ Mock geolocation: clearWatch called');
          }
        };
        
        // Override geolocation completely to prevent policy issues
        if (window.navigator && window.navigator.geolocation) {
          Object.defineProperty(navigator, 'geolocation', {
            value: mockGeolocation,
            writable: false,
            configurable: false
          });
        } else {
          navigator.geolocation = mockGeolocation;
        }
        
        console.log('‚úÖ Geolocation mock active (Madrid, Espa√±a)');
      })();
    </script>

    <!-- PayPal Button Initialization -->
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        console.log('Initializing PayPal...');
        
        let paypalInitialized = false;
        let initTimeout = null;
        
        // Check if on coffee page
        function isOnCoffeePage() {
          return window.location.hash === '#/coffee' || 
                 document.getElementById("paypal-container-MRSQEQV646EPA") !== null;
        }
          // Initialize PayPal button with mobile-optimized logic
        function initPayPalButton() {
          const container = document.getElementById("paypal-container-MRSQEQV646EPA");
          
          if (!window.paypal) {
            console.log('PayPal SDK not ready, retrying...');
            setTimeout(initPayPalButton, 500);
            return;
          }
          
          if (!container) {
            console.log('PayPal container not found, retrying...');
            setTimeout(initPayPalButton, 500);
            return;
          }
          
          // Extra validation for mobile: ensure container is stable in DOM
          if (!document.body.contains(container)) {
            console.log('Container not attached to body, waiting...');
            setTimeout(initPayPalButton, 300);
            return;
          }
          
          // Check if container parent is stable (important for React re-renders)
          const containerParent = container.parentNode;
          if (!containerParent || !document.body.contains(containerParent)) {
            console.log('Container parent not stable, waiting...');
            setTimeout(initPayPalButton, 300);
            return;
          }
          
          console.log('‚úÖ Rendering PayPal button...');
          container.innerHTML = '';
            try {
            const isMobile = window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            window.paypal.Buttons({
              env: 'sandbox',
              style: {
                layout: 'vertical',
                color: 'gold',
                shape: 'rect',
                label: 'donate',
                height: isMobile ? 40 : 44, // Altura ajustada para m√≥viles
                tagline: false
              },
              
              // No restringir funding source en producci√≥n para m√≥viles
              fundingSource: window.isLocalhost ? window.paypal.FUNDING.PAYPAL : undefined,
              
              onClick: function(data, actions) {
                console.log('üñ±Ô∏è PayPal button clicked');
                
                const amountInput = document.querySelector('input[name="amount"]#donation-amount') || 
                                   document.querySelector('input[name="amount"]#donation-amount-mobile');
                
                if (amountInput) {
                  const inputValue = parseFloat(amountInput.value);
                  if (!inputValue || inputValue <= 0 || inputValue > 1000) {
                    console.log('‚ö†Ô∏è Invalid amount, rejecting payment');
                    return actions.reject();
                  }
                }
                
                return actions.resolve();
              },
                createOrder: function(data, actions) {
                console.log('üîÑ Creating PayPal order');
                
                let amount = '5.00';
                const amountInput = document.querySelector('input[name="amount"]#donation-amount') || 
                                   document.querySelector('input[name="amount"]#donation-amount-mobile');
                
                if (amountInput && amountInput.value) {
                  const inputValue = parseFloat(amountInput.value);
                  if (inputValue && inputValue > 0 && inputValue <= 1000) {
                    amount = inputValue.toFixed(2);
                  }
                }
                
                console.log('üí∞ Order amount:', amount);
                
                // Enhanced order configuration for EUR and Spain
                const orderConfig = {
                  intent: 'CAPTURE',
                  purchase_units: [{
                    amount: {
                      value: amount,
                      currency_code: 'EUR'
                    },
                    description: 'Donaci√≥n de caf√© - Masterpiece Collection'
                  }],
                  application_context: {
                    shipping_preference: 'NO_SHIPPING',
                    user_action: 'PAY_NOW',
                    locale: 'es-ES',
                    landing_page: 'BILLING'
                  }
                };
                
                console.log('üì¶ Order config:', orderConfig);
                
                return actions.order.create(orderConfig);
              },
              
              onApprove: function(data, actions) {
                console.log('Payment approved:', data);
                return actions.order.capture().then(function(details) {
                  console.log('Payment completed:', details);
                  
                  const successMsg = document.createElement('div');
                  successMsg.innerHTML = `
                    <div style="background: #4CAF50; color: white; padding: 15px; border-radius: 8px; text-align: center; margin: 10px 0;">
                      ¬°Gracias por tu donaci√≥n, ${details.payer.name.given_name}! Tu apoyo significa mucho. ‚òïÔ∏è
                    </div>
                  `;
                  
                  container.parentNode.insertBefore(successMsg, container.nextSibling);
                  
                  setTimeout(() => {
                    successMsg.remove();
                  }, 5000);
                });
              },
                onError: function(err) {
                console.error('‚ùå PayPal error:', err);
                
                let errorMessage = 'Ha ocurrido un error. Por favor, int√©ntalo de nuevo.';
                let shouldShow = true;
                
                if (err && err.message) {
                  if (err.message.includes('DOMESTIC_TRANSACTION_REQUIRED')) {
                    console.log('üîß DOMESTIC_TRANSACTION_REQUIRED error detected - this should be resolved with buyer-country=ES');
                    errorMessage = 'Error de configuraci√≥n regional. Reintentando...';
                    shouldShow = false; // Don't show user error, this is a config issue
                  } else if (err.message.includes('INSTRUMENT_DECLINED')) {
                    errorMessage = 'Pago declinado. Por favor, verifica tu m√©todo de pago.';
                  } else if (err.message.includes('PAYER_ACTION_REQUIRED')) {
                    errorMessage = 'Se requiere acci√≥n del pagador. Por favor, completa el pago.';
                  }
                }
                
                if (shouldShow) {
                  const errorDiv = document.createElement('div');
                  errorDiv.innerHTML = `
                    <div style="background: #f44336; color: white; padding: 15px; border-radius: 8px; text-align: center; margin: 10px 0;">
                      ${errorMessage}
                    </div>
                  `;
                  
                  container.parentNode.insertBefore(errorDiv, container.nextSibling);
                  
                  setTimeout(() => {
                    errorDiv.remove();
                  }, 5000);
                }
              },
              
              onCancel: function(data) {
                console.log('Payment cancelled:', data);
              }            }).render('#paypal-container-MRSQEQV646EPA').then(function() {
              console.log('‚úÖ PayPal button rendered successfully');
              paypalInitialized = true;
            }).catch(function(err) {
              console.error('‚ùå Error rendering PayPal button:', err);
              paypalInitialized = false;
              
              // Handle specific mobile errors
              if (err.message && err.message.includes('container element removed from DOM')) {
                console.log('üîÑ Container removed during render, will retry on next navigation...');
                // Don't retry immediately for this error as it's usually due to navigation
                return;
              }
              
              // For other errors, retry after a delay
              console.log('üîÑ Retrying PayPal initialization in 2 seconds...');
              setTimeout(() => {
                if (isOnCoffeePage() && document.getElementById("paypal-container-MRSQEQV646EPA")) {
                  debouncedPayPalInit();
                }
              }, 2000);
            });
          } catch (error) {
            console.error('‚ùå Error in PayPal initialization:', error);
            paypalInitialized = false;
            
            // Handle DOM-related errors specifically
            if (error.message && error.message.includes('container element removed from DOM')) {
              console.log('üîÑ Container removed during initialization, will retry on next navigation...');
              return;
            }
            
            // For other errors, retry
            setTimeout(() => {
              if (isOnCoffeePage() && document.getElementById("paypal-container-MRSQEQV646EPA")) {
                debouncedPayPalInit();
              }
            }, 1500);
          }
        }
          // Debounced initialization with mobile optimization
        function debouncedPayPalInit() {
          if (initTimeout) {
            clearTimeout(initTimeout);
          }
          
          // Longer timeout for mobile devices to allow React to stabilize
          const isMobile = window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
          const delay = isMobile ? 1000 : 500; // Longer delay for mobile
          
          initTimeout = setTimeout(() => {
            if (isOnCoffeePage() && !paypalInitialized) {
              const container = document.getElementById("paypal-container-MRSQEQV646EPA");
              
              // Extra check: ensure container has been stable for a bit
              if (container && document.body.contains(container)) {
                initPayPalButton();
              } else {
                console.log('Container not stable yet, will retry...');
              }
            }
          }, delay);
        }
          // Observer for DOM changes with mobile optimization
        const observer = new MutationObserver(function(mutations) {
          let shouldInitialize = false;
          
          // Check if PayPal container was added
          mutations.forEach(function(mutation) {
            if (mutation.type === 'childList') {
              mutation.addedNodes.forEach(function(node) {
                if (node.nodeType === Node.ELEMENT_NODE) {
                  // Check if the container was added or if it contains the container
                  if (node.id === 'paypal-container-MRSQEQV646EPA' || 
                      node.querySelector && node.querySelector('#paypal-container-MRSQEQV646EPA')) {
                    shouldInitialize = true;
                  }
                }
              });
            }
          });
          
          // Only initialize if we detected the container was added and we're on the right page
          if (shouldInitialize && isOnCoffeePage() && !paypalInitialized) {
            console.log('PayPal container detected in DOM, initializing...');
            debouncedPayPalInit();
          }
        });
        
        observer.observe(document.body, {
          childList: true,
          subtree: true
        });
          // Route change listeners with mobile optimization
        window.addEventListener('hashchange', function() {
          console.log('Hash change detected:', window.location.hash);
          
          if (isOnCoffeePage()) {
            // Reset state and reinitialize
            paypalInitialized = false;
            setTimeout(() => {
              debouncedPayPalInit();
            }, 200); // Small delay for mobile
          } else {
            // Clean up when leaving coffee page
            paypalInitialized = false;
            if (initTimeout) {
              clearTimeout(initTimeout);
              initTimeout = null;
            }
          }
        });
        
        window.addEventListener('popstate', function() {
          console.log('Popstate detected');
          
          if (isOnCoffeePage()) {
            // Reset state and reinitialize
            paypalInitialized = false;
            setTimeout(() => {
              debouncedPayPalInit();
            }, 200); // Small delay for mobile
          } else {
            // Clean up when leaving coffee page
            paypalInitialized = false;
            if (initTimeout) {
              clearTimeout(initTimeout);
              initTimeout = null;
            }
          }
        });
          // Global function for React with mobile optimization
        window.initializePayPal = function() {
          console.log('PayPal initialization requested from React');
          paypalInitialized = false; // Reset to allow re-initialization
          debouncedPayPalInit();
        };
        
        // Initial check with mobile-optimized timing
        const isMobile = window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const initialDelay = isMobile ? 1500 : 1000; // Longer delay for mobile
        
        setTimeout(function() {
          if (isOnCoffeePage()) {
            console.log('Initial PayPal check - Coffee page detected');
            debouncedPayPalInit();
          }
        }, initialDelay);
      });
    </script>

    <!-- Console Filtering for PayPal Warnings -->
    <script>
      (function() {
        const originalError = console.error;
        const originalWarn = console.warn;
        const originalLog = console.log;
          // Improved check for PayPal atomics errors
        function isPayPalAtomicsError(args) {
          // Check for the specific pattern: undefined 'atomics_error_getting_devlogger_extension'
          if (args.length >= 2 && 
              args[0] === undefined && 
              typeof args[1] === 'string' && 
              args[1].includes('atomics_error_getting_devlogger_extension')) {
            return true;
          }
          
          // Check for SecurityError related to __ATOMIC_EVENTS_DEV_LOGGER__
          for (let arg of args) {
            if (arg instanceof Error && arg.message) {
              if (arg.message.includes('__ATOMIC_EVENTS_DEV_LOGGER__') ||
                  arg.message.includes('atomics_error_getting_devlogger_extension') ||
                  (arg.message.includes('Blocked a frame with origin') && 
                   arg.message.includes('paypal.com'))) {
                return true;
              }
            }
            
            if (typeof arg === 'string') {
              if (arg.includes('__ATOMIC_EVENTS_DEV_LOGGER__') ||
                  arg.includes('atomics_error_getting_devlogger_extension') ||
                  (arg.includes('Blocked a frame with origin') && 
                   arg.includes('paypal.com'))) {
                return true;
              }
            }
          }
          
          return false;
        }
        
        // Filter PayPal-specific warnings and errors
        console.error = function(...args) {
          // Check for PayPal atomics errors first
          if (isPayPalAtomicsError(args)) {
            return;
          }
          
          const message = args.join(' ');
          
          if (message.includes('ncps_standalone_paylater_ineligible') || 
              message.includes('paypal_js_sdk_v5_unhandled_exception') ||
              message.includes('geolocation is not allowed') ||
              message.includes('DOMESTIC_TRANSACTION_REQUIRED') ||
              message.includes('atomics_error_getting_devlogger_extension') ||
              message.includes('__ATOMIC_EVENTS_DEV_LOGGER__') ||
              (message.includes('Blocked a frame with origin') && message.includes('paypal.com')) ||
              message.includes('Converting circular structure to JSON')) {
            return;
          }
          
          originalError.apply(console, args);
        };
          console.warn = function(...args) {
          // Check for PayPal atomics errors first
          if (isPayPalAtomicsError(args)) {
            return;
          }
          
          const message = args.join(' ');
          
          if (message.includes('ncps_standalone_paylater_ineligible') || 
              message.includes('Pay Later ineligible') ||
              message.includes('Symbol.observable as defined by Redux') ||
              message.includes('atomics_error_getting_devlogger_extension') ||
              message.includes('__ATOMIC_EVENTS_DEV_LOGGER__')) {
            return;
          }
          
          originalWarn.apply(console, args);
        };
        
        console.log = function(...args) {
          // Check for PayPal atomics errors first
          if (isPayPalAtomicsError(args)) {
            return;
          }
          
          const message = args.join(' ');
          
          if (message.includes('atomics_error_getting_devlogger_extension') ||
              message.includes('__ATOMIC_EVENTS_DEV_LOGGER__')) {
            return;
          }
          
          originalLog.apply(console, args);
        };
          // Error event listeners
        window.addEventListener('error', function(event) {
          if (event.error && event.error.message && 
              (event.error.message.includes('geolocation is not allowed') ||
               event.error.message.includes('DOMESTIC_TRANSACTION_REQUIRED') ||
               event.error.message.includes('atomics_error_getting_devlogger_extension') ||
               event.error.message.includes('__ATOMIC_EVENTS_DEV_LOGGER__') ||
               (event.error.message.includes('Blocked a frame with origin') && 
                event.error.message.includes('paypal.com')) ||
               (event.filename && event.filename.includes('paypal.com')))) {
            event.preventDefault();
            return true;
          }
        });
        
        window.addEventListener('unhandledrejection', function(event) {
          if (event.reason && 
              (event.reason.message?.includes('geolocation') ||
               event.reason.message?.includes('DOMESTIC_TRANSACTION_REQUIRED') ||
               event.reason.message?.includes('atomics_error_getting_devlogger_extension') ||
               event.reason.message?.includes('__ATOMIC_EVENTS_DEV_LOGGER__') ||
               (event.reason.message?.includes('Blocked a frame with origin') && 
                event.reason.message?.includes('paypal.com')))) {
            event.preventDefault();
            return true;
          }
        });
      })();
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
