<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vite + React</title>
      <!-- PayPal SDK Script - Usando sandbox para pruebas -->
    <script
      src="https://www.paypal.com/sdk/js?client-id=AZDxjDScFpQtjWTOUtWKbyN_bDt4OgqaF4eYXlewfBP4-8aqX3PiV8e1GWU6liB2CUXlkA59kJXE7M6R&components=buttons&disable-funding=venmo&currency=EUR&intent=capture"
      crossorigin="anonymous"
      async>
    </script>
    
    <!-- PayPal Button Initialization Script -->
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        console.log('DOM cargado, inicializando PayPal...');
        
        // Función para verificar si estamos en móvil
        function isMobile() {
          return window.innerWidth <= 768;
        }
        
        // Función para inicializar PayPal Button
        function initPayPalButton() {
          const container = document.getElementById("paypal-container-MRSQEQV646EPA");
          const wrapper = document.getElementById("paypal-button-wrapper");
          
          console.log('Intentando inicializar PayPal...');
          console.log('Móvil:', isMobile());
          console.log('Container encontrado:', !!container);
          console.log('Wrapper encontrado:', !!wrapper);
          console.log('PayPal SDK disponible:', !!window.paypal);
          
          if (!window.paypal) {
            console.log('PayPal SDK no disponible aún, reintentando en 500ms...');
            setTimeout(initPayPalButton, 500);
            return;
          }
          
          if (!container) {
            console.log('Contenedor PayPal no encontrado, reintentando en 500ms...');
            setTimeout(initPayPalButton, 500);
            return;
          }
          
          console.log('✅ Inicializando botón PayPal...');
          
          if (wrapper) wrapper.classList.add('loading');
          container.innerHTML = '';
            try {
            window.paypal.Buttons({
              // Configuración para sandbox/testing
              env: 'sandbox', // Cambiar a 'production' cuando tengas permisos
              
              style: {
                layout: 'vertical',
                color: 'gold',
                shape: 'rect',
                label: 'donate',
                height: 44
              },
              
              createOrder: function(data, actions) {
                // Obtener la cantidad del input o usar 5 EUR por defecto
                let amount = '5.00';
                
                // Buscar el input en ambas versiones (desktop y móvil)
                const amountInputDesktop = document.querySelector('input[name="amount"]#donation-amount');
                const amountInputMobile = document.querySelector('input[name="amount"]#donation-amount-mobile');
                const amountInput = amountInputDesktop || amountInputMobile;
                
                if (amountInput && amountInput.value) {
                  const inputValue = parseFloat(amountInput.value);
                  if (inputValue && inputValue > 0) {
                    amount = inputValue.toFixed(2);
                  }
                }
                  console.log('Creando orden PayPal con cantidad:', amount);
                console.log('Input usado:', amountInput ? amountInput.id : 'ninguno');
                console.log('Entorno:', 'sandbox');
                
                return actions.order.create({
                  intent: 'CAPTURE',
                  purchase_units: [{
                    amount: {
                      value: amount,
                      currency_code: 'EUR'
                    },
                    description: 'Donación para Masterpiece - Café para el desarrollador'
                  }],
                  application_context: {
                    brand_name: 'Masterpiece App',
                    locale: 'es-ES',
                    user_action: 'PAY_NOW'
                  }
                });
              },
              
              onApprove: function(data, actions) {
                console.log('Pago aprobado:', data);
                return actions.order.capture().then(function(details) {
                  console.log('Pago completado:', details);
                  
                  // Mostrar mensaje de éxito
                  const successMsg = document.createElement('div');
                  successMsg.innerHTML = `
                    <div style="
                      background: #4CAF50;
                      color: white;
                      padding: 15px;
                      border-radius: 8px;
                      text-align: center;
                      margin: 10px 0;
                      font-size: 14px;
                    ">
                      ¡Gracias por tu donación, ${details.payer.name.given_name}! 
                      Tu apoyo significa mucho. ☕️
                    </div>
                  `;
                  
                  container.parentNode.insertBefore(successMsg, container.nextSibling);
                  
                  // Ocultar el contenedor del botón temporalmente
                  setTimeout(() => {
                    if (wrapper) wrapper.style.display = 'none';
                    setTimeout(() => {
                      if (wrapper) wrapper.style.display = 'block';
                      successMsg.remove();
                      // Reinicializar el botón
                      setTimeout(initPayPalButton, 1000);
                    }, 5000);
                  }, 2000);
                });
              },
              
              onError: function(err) {
                console.error('Error en el pago:', err);
                
                const errorMsg = document.createElement('div');
                errorMsg.innerHTML = `
                  <div style="
                    background: #f44336;
                    color: white;
                    padding: 15px;
                    border-radius: 8px;
                    text-align: center;
                    margin: 10px 0;
                    font-size: 14px;
                  ">
                    Ha ocurrido un error. Por favor, inténtalo de nuevo.
                  </div>
                `;
                
                container.parentNode.insertBefore(errorMsg, container.nextSibling);
                
                setTimeout(() => {
                  errorMsg.remove();
                }, 5000);
              },
              
              onCancel: function(data) {
                console.log('Pago cancelado:', data);
              }
                }).render('#paypal-container-MRSQEQV646EPA').then(function() {
              console.log('✅ Botón PayPal renderizado correctamente');
              console.log('Container después del render:', container);
              console.log('Container tiene contenido:', container.innerHTML.length > 0);
              
              // Marcar como inicializado exitosamente
              paypalInitialized = true;
              
              if (wrapper) {
                wrapper.classList.remove('loading');
                wrapper.classList.add('loaded');
              }
              
              // Aplicar estilos móviles después de renderizar
              setTimeout(() => {
                applyMobileStyles();
              }, 500);            }).catch(function(err) {
              console.error('❌ Error al renderizar botón PayPal:', err);
              if (wrapper) wrapper.classList.remove('loading');
              
              // Resetear completamente el estado en caso de error
              paypalInitialized = false;
              
              // Si el error es de contenedor removido, intentar una vez más después de un delay mayor
              if (err.message && err.message.includes('container element removed from DOM')) {
                console.log('Error de contenedor removido, reintentando después de delay mayor...');
                setTimeout(() => {
                  if (isOnCoffeePage()) {
                    debouncedPayPalInit();
                  }
                }, 2000);
              } else {
                console.log('Otro tipo de error, no se reintentará automáticamente');
              }
            });
              } catch (error) {
            console.error('❌ Error en inicialización PayPal:', error);
            if (wrapper) wrapper.classList.remove('loading');
            
            // Resetear la variable de inicialización en caso de error
            paypalInitialized = false;
            
            console.log('Error en try/catch, no se reintentará automáticamente');
          }
        }
        
        // Función para aplicar estilos móviles
        function applyMobileStyles() {
          if (isMobile()) {
            console.log('Aplicando estilos móviles a PayPal...');
            
            const container = document.getElementById("paypal-container-MRSQEQV646EPA");
            if (!container) return;
            
            // Estilos para el contenedor principal
            container.style.cssText = `
              width: 100% !important;
              max-width: 300px !important;
              margin: 0 auto !important;
              text-align: center !important;
            `;
            
            // Estilos para todos los elementos PayPal
            const paypalElements = container.querySelectorAll('*');
            paypalElements.forEach(element => {
              if (element.tagName === 'DIV' || element.tagName === 'IFRAME') {
                element.style.cssText += `
                  width: 100% !important;
                  max-width: 300px !important;
                  margin: 0 auto !important;
                  border-radius: 8px !important;
                `;
              }
            });
            
            console.log('✅ Estilos móviles aplicados a PayPal');
          }
        }
          // Aplicar estilos en redimensionamiento
        window.addEventListener('resize', () => {
          setTimeout(applyMobileStyles, 100);
        });        // Variable para controlar si PayPal ya está inicializado
        let paypalInitialized = false;
        let observerActive = false;
        let initTimeout = null;
        
        // Función para verificar si estamos en la página de coffee
        function isOnCoffeePage() {
          return window.location.hash === '#/coffee' || 
                 window.location.pathname.includes('/coffee') ||
                 document.getElementById("paypal-container-MRSQEQV646EPA") !== null;
        }
        
        // Función con debounce para evitar múltiples inicializaciones
        function debouncedPayPalInit() {
          // Cancelar cualquier inicialización pendiente
          if (initTimeout) {
            clearTimeout(initTimeout);
            initTimeout = null;
          }
          
          // Programar nueva inicialización con delay
          initTimeout = setTimeout(() => {
            initPayPalWhenReady();
            initTimeout = null;
          }, 800); // Más tiempo para que React termine de renderizar
        }
        
        // Función para inicializar PayPal solo cuando sea necesario
        function initPayPalWhenReady() {
          if (!isOnCoffeePage()) {
            console.log('No estamos en la página de coffee, esperando...');
            return;
          }
          
          const container = document.getElementById("paypal-container-MRSQEQV646EPA");
          
          if (!container || !document.body.contains(container)) {
            console.log('Contenedor no disponible en página de coffee, esperando...');
            return;
          }
          
          // Verificar si el contenedor está siendo manipulado por React
          const containerParent = container.parentNode;
          if (!containerParent || !document.body.contains(containerParent)) {
            console.log('Contenedor padre no estable, esperando...');
            setTimeout(debouncedPayPalInit, 500);
            return;
          }
          
          // Verificar si ya hay contenido PayPal en el contenedor
          if (container.children.length > 0 && paypalInitialized) {
            console.log('PayPal ya está inicializado y funcionando correctamente');
            return;
          }
          
          // Marcar como en proceso para evitar dobles inicializaciones
          if (paypalInitialized) {
            console.log('PayPal ya está en proceso de inicialización');
            return;
          }
          
          console.log('✅ Inicializando PayPal en página de coffee');
          paypalInitialized = true; // Marcar antes de intentar renderizar
          initPayPalButton();
        }
        
        // Observador para detectar cuando estemos en la página de coffee
        function startPayPalObserver() {
          if (observerActive) return;
          
          observerActive = true;
          
          const observer = new MutationObserver(function(mutations) {
            let containerDetected = false;
            
            mutations.forEach(function(mutation) {
              if (mutation.type === 'childList') {
                // Verificar si se agregó el contenedor de PayPal
                const container = document.getElementById("paypal-container-MRSQEQV646EPA");
                if (container && !containerDetected && isOnCoffeePage()) {
                  containerDetected = true;
                  console.log('✅ Contenedor PayPal detectado en página de coffee');
                }
              }
            });
            
            // Solo inicializar una vez por batch de mutaciones
            if (containerDetected) {
              debouncedPayPalInit();
            }
          });
          
          // Observar cambios en el DOM
          observer.observe(document.body, {
            childList: true,
            subtree: true
          });
          
          console.log('Observer de PayPal iniciado');
        }
          // Detectar cambios de ruta en React Router
        function setupRouteListener() {
          // Escuchar cambios en el hash para React Router
          window.addEventListener('hashchange', function() {
            console.log('Cambio de ruta detectado:', window.location.hash);
            if (isOnCoffeePage()) {
              debouncedPayPalInit();
            } else {
              // Limpiar estado cuando sales de la página de coffee
              paypalInitialized = false;
              if (initTimeout) {
                clearTimeout(initTimeout);
                initTimeout = null;
              }
            }
          });
          
          // También escuchar el evento popstate
          window.addEventListener('popstate', function() {
            console.log('Popstate detectado');
            if (isOnCoffeePage()) {
              debouncedPayPalInit();
            } else {
              paypalInitialized = false;
              if (initTimeout) {
                clearTimeout(initTimeout);
                initTimeout = null;
              }
            }
          });
        }
          // Inicialización
        startPayPalObserver();
        setupRouteListener();
          // Función global para que React pueda llamarla
        window.initializePayPal = function() {
          console.log('PayPal inicialización solicitada desde React');
          debouncedPayPalInit();
        };
        
        // Verificar si ya estamos en la página de coffee al cargar
        setTimeout(function() {
          if (isOnCoffeePage()) {
            initPayPalWhenReady();
          }
        }, 1000);
      });
    </script>
    
    <!-- Script para suprimir warnings específicos de PayPal que no afectan la funcionalidad -->
    <script>
      // Interceptar y filtrar warnings de PayPal en desarrollo
      const originalError = console.error;
      const originalWarn = console.warn;
      
      console.error = function(...args) {
        const message = args.join(' ');
        // Filtrar errores específicos de PayPal que no afectan la funcionalidad
        if (message.includes('ncps_standalone_paylater_ineligible') || 
            message.includes('paylater_ineligible') ||
            message.includes('paypal_js_sdk_v5_unhandled_exception') ||
            message.includes('Cannot read properties of null') ||
            message.includes('classList') ||
            message.includes('renderErrors')) {
          return; // No mostrar estos errores
        }
        originalError.apply(console, args);
      };
      
      console.warn = function(...args) {
        const message = args.join(' ');
        // Filtrar warnings relacionados con PayPal
        if (message.includes('ncps_standalone_paylater_ineligible') || 
            message.includes('paylater_ineligible') ||
            message.includes('Pay Later ineligible') ||
            message.includes('paypal_js_sdk')) {
          return; // No mostrar estos warnings
        }
        originalWarn.apply(console, args);
      };
      
      // Interceptar errores no capturados de PayPal
      window.addEventListener('error', function(event) {
        if (event.error && event.error.message && 
            (event.error.message.includes('Cannot read properties of null') ||
             event.error.message.includes('classList') ||
             event.error.message.includes('renderErrors') ||
             event.filename && event.filename.includes('paypal.com'))) {
          event.preventDefault();
          return true;
        }
      });
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
