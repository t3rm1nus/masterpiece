<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Permissions-Policy" content="geolocation=(), camera=(), microphone=(), payment=(), accelerometer=(), gyroscope=()">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <title>Vite + React</title>

    <!-- Symbol.observable polyfill for Redux -->
    <script>
      (function() {
        if (typeof Symbol === 'undefined') {
          window.Symbol = {};
        }
        
        const $$observable = typeof Symbol === 'function' && Symbol.observable || '@@observable';
        
        if (!Symbol.observable) {
          Symbol.observable = $$observable;
        }
        
        if (typeof Symbol.observable === 'string') {
          Symbol.observable = Symbol.for ? Symbol.for(Symbol.observable) : $$observable;
        }
        
        console.log('‚úÖ Symbol.observable configurado:', Symbol.observable);
      })();
    </script>

    <!-- Environment Detection and PayPal SDK -->
    <script>
      // Detect environment
      window.isLocalhost = window.location.hostname === 'localhost' || 
                          window.location.hostname === '127.0.0.1' || 
                          window.location.port === '5173' ||
                          window.location.port === '3000';
      
      window.isProduction = !window.isLocalhost;
      
      console.log('üåç Environment:', {
        hostname: window.location.hostname,
        isLocalhost: window.isLocalhost,
        isProduction: window.isProduction
      });
      
      // Load PayPal SDK
      const sdkUrl = window.isLocalhost 
        ? "https://www.paypal.com/sdk/js?client-id=AZDxjDScFpQtjWTOUtWKbyN_bDt4OgqaF4eYXlewfBP4-8aqX3PiV8e1GWU6liB2CUXlkA59kJXE7M6R&components=buttons&disable-funding=venmo,card&currency=EUR&debug=true"
        : "https://www.paypal.com/sdk/js?client-id=AZDxjDScFpQtjWTOUtWKbyN_bDt4OgqaF4eYXlewfBP4-8aqX3PiV8e1GWU6liB2CUXlkA59kJXE7M6R&components=buttons&currency=EUR&locale=es_ES&disable-funding=venmo";
      
      const script = document.createElement('script');
      script.src = sdkUrl;
      script.crossOrigin = 'anonymous';
      script.async = true;
      document.head.appendChild(script);
      
      console.log('üí≥ PayPal SDK loaded for:', window.isLocalhost ? 'localhost' : 'production');
    </script>

    <!-- Geolocation Mock -->
    <script>
      (function() {
        console.log('üö´ Setting up geolocation mock...');
        
        // Create complete geolocation mock
        const mockGeolocation = {
          getCurrentPosition: function(success, error, options) {
            console.log('üá™üá∏ Mock geolocation: Madrid, Spain');
            if (success) {
              setTimeout(() => {
                success({
                  coords: {
                    latitude: 40.4168,
                    longitude: -3.7038,
                    altitude: null,
                    accuracy: 100,
                    altitudeAccuracy: null,
                    heading: null,
                    speed: null
                  },
                  timestamp: Date.now()
                });
              }, 100);
            }
          },
          watchPosition: function(success, error, options) {
            const id = Math.random();
            this.getCurrentPosition(success, error, options);
            return id;
          },
          clearWatch: function(id) {
            console.log('Mock geolocation: clearWatch called');
          }
        };
        
        // Always use mock to avoid policy violations
        Object.defineProperty(navigator, 'geolocation', {
          value: mockGeolocation,
          writable: false,
          configurable: false
        });
        
        console.log('‚úÖ Geolocation mock active');
      })();
    </script>

    <!-- PayPal Button Initialization -->
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        console.log('Initializing PayPal...');
        
        let paypalInitialized = false;
        let initTimeout = null;
        
        // Check if on coffee page
        function isOnCoffeePage() {
          return window.location.hash === '#/coffee' || 
                 document.getElementById("paypal-container-MRSQEQV646EPA") !== null;
        }
        
        // Initialize PayPal button
        function initPayPalButton() {
          const container = document.getElementById("paypal-container-MRSQEQV646EPA");
          
          if (!window.paypal) {
            console.log('PayPal SDK not ready, retrying...');
            setTimeout(initPayPalButton, 500);
            return;
          }
          
          if (!container) {
            console.log('PayPal container not found, retrying...');
            setTimeout(initPayPalButton, 500);
            return;
          }
          
          console.log('‚úÖ Rendering PayPal button...');
          container.innerHTML = '';
          
          try {
            window.paypal.Buttons({
              env: 'sandbox',
              style: {
                layout: 'vertical',
                color: 'gold',
                shape: 'rect',
                label: 'donate',
                height: 44,
                tagline: false
              },
              
              fundingSource: window.isLocalhost ? window.paypal.FUNDING.PAYPAL : undefined,
              
              onClick: function(data, actions) {
                console.log('üñ±Ô∏è PayPal button clicked');
                
                const amountInput = document.querySelector('input[name="amount"]#donation-amount') || 
                                   document.querySelector('input[name="amount"]#donation-amount-mobile');
                
                if (amountInput) {
                  const inputValue = parseFloat(amountInput.value);
                  if (!inputValue || inputValue <= 0 || inputValue > 1000) {
                    console.log('‚ö†Ô∏è Invalid amount, rejecting payment');
                    return actions.reject();
                  }
                }
                
                return actions.resolve();
              },
              
              createOrder: function(data, actions) {
                console.log('üîÑ Creating PayPal order');
                
                let amount = '5.00';
                const amountInput = document.querySelector('input[name="amount"]#donation-amount') || 
                                   document.querySelector('input[name="amount"]#donation-amount-mobile');
                
                if (amountInput && amountInput.value) {
                  const inputValue = parseFloat(amountInput.value);
                  if (inputValue && inputValue > 0 && inputValue <= 1000) {
                    amount = inputValue.toFixed(2);
                  }
                }
                
                console.log('üí∞ Order amount:', amount);
                
                return actions.order.create({
                  intent: 'CAPTURE',
                  purchase_units: [{
                    amount: {
                      value: amount,
                      currency_code: 'EUR'
                    }
                  }],
                  application_context: {
                    shipping_preference: 'NO_SHIPPING',
                    user_action: 'PAY_NOW'
                  }
                });
              },
              
              onApprove: function(data, actions) {
                console.log('Payment approved:', data);
                return actions.order.capture().then(function(details) {
                  console.log('Payment completed:', details);
                  
                  const successMsg = document.createElement('div');
                  successMsg.innerHTML = `
                    <div style="background: #4CAF50; color: white; padding: 15px; border-radius: 8px; text-align: center; margin: 10px 0;">
                      ¬°Gracias por tu donaci√≥n, ${details.payer.name.given_name}! Tu apoyo significa mucho. ‚òïÔ∏è
                    </div>
                  `;
                  
                  container.parentNode.insertBefore(successMsg, container.nextSibling);
                  
                  setTimeout(() => {
                    successMsg.remove();
                  }, 5000);
                });
              },
              
              onError: function(err) {
                console.error('‚ùå PayPal error:', err);
                
                let errorMessage = 'Ha ocurrido un error. Por favor, int√©ntalo de nuevo.';
                
                if (err && err.message) {
                  if (err.message.includes('DOMESTIC_TRANSACTION_REQUIRED')) {
                    errorMessage = 'Error de configuraci√≥n de pagos. Por favor, contacta al soporte.';
                  } else if (err.message.includes('INSTRUMENT_DECLINED')) {
                    errorMessage = 'Pago declinado. Por favor, verifica tu m√©todo de pago.';
                  }
                }
                
                const errorDiv = document.createElement('div');
                errorDiv.innerHTML = `
                  <div style="background: #f44336; color: white; padding: 15px; border-radius: 8px; text-align: center; margin: 10px 0;">
                    ${errorMessage}
                  </div>
                `;
                
                container.parentNode.insertBefore(errorDiv, container.nextSibling);
                
                setTimeout(() => {
                  errorDiv.remove();
                }, 5000);
              },
              
              onCancel: function(data) {
                console.log('Payment cancelled:', data);
              }
            }).render('#paypal-container-MRSQEQV646EPA').then(function() {
              console.log('‚úÖ PayPal button rendered successfully');
              paypalInitialized = true;
            }).catch(function(err) {
              console.error('‚ùå Error rendering PayPal button:', err);
              paypalInitialized = false;
            });
          } catch (error) {
            console.error('‚ùå Error in PayPal initialization:', error);
            paypalInitialized = false;
          }
        }
        
        // Debounced initialization
        function debouncedPayPalInit() {
          if (initTimeout) {
            clearTimeout(initTimeout);
          }
          
          initTimeout = setTimeout(() => {
            if (isOnCoffeePage() && !paypalInitialized) {
              initPayPalButton();
            }
          }, 500);
        }
        
        // Observer for DOM changes
        const observer = new MutationObserver(function(mutations) {
          const container = document.getElementById("paypal-container-MRSQEQV646EPA");
          if (container && isOnCoffeePage() && !paypalInitialized) {
            debouncedPayPalInit();
          }
        });
        
        observer.observe(document.body, {
          childList: true,
          subtree: true
        });
        
        // Route change listeners
        window.addEventListener('hashchange', function() {
          if (isOnCoffeePage()) {
            debouncedPayPalInit();
          } else {
            paypalInitialized = false;
          }
        });
        
        window.addEventListener('popstate', function() {
          if (isOnCoffeePage()) {
            debouncedPayPalInit();
          } else {
            paypalInitialized = false;
          }
        });
        
        // Global function for React
        window.initializePayPal = function() {
          console.log('PayPal initialization requested from React');
          debouncedPayPalInit();
        };
        
        // Initial check
        setTimeout(function() {
          if (isOnCoffeePage()) {
            debouncedPayPalInit();
          }
        }, 1000);
      });
    </script>

    <!-- Console Filtering for PayPal Warnings -->
    <script>
      (function() {
        const originalError = console.error;
        const originalWarn = console.warn;
        const originalLog = console.log;
        
        // Filter PayPal-specific warnings and errors
        console.error = function(...args) {
          const message = args.join(' ');
          
          if (message.includes('ncps_standalone_paylater_ineligible') || 
              message.includes('paypal_js_sdk_v5_unhandled_exception') ||
              message.includes('geolocation is not allowed') ||
              message.includes('DOMESTIC_TRANSACTION_REQUIRED') ||
              message.includes('atomics_error_getting_devlogger_extension') ||
              message.includes('Blocked a frame with origin') ||
              message.includes('Converting circular structure to JSON')) {
            return;
          }
          
          originalError.apply(console, args);
        };
        
        console.warn = function(...args) {
          const message = args.join(' ');
          
          if (message.includes('ncps_standalone_paylater_ineligible') || 
              message.includes('Pay Later ineligible') ||
              message.includes('Symbol.observable as defined by Redux') ||
              message.includes('atomics_error_getting_devlogger_extension')) {
            return;
          }
          
          originalWarn.apply(console, args);
        };
        
        console.log = function(...args) {
          const message = args.join(' ');
          
          if (message.includes('atomics_error_getting_devlogger_extension') ||
              message.includes('__ATOMIC_EVENTS_DEV_LOGGER__')) {
            return;
          }
          
          originalLog.apply(console, args);
        };
        
        // Error event listeners
        window.addEventListener('error', function(event) {
          if (event.error && event.error.message && 
              (event.error.message.includes('geolocation is not allowed') ||
               event.error.message.includes('DOMESTIC_TRANSACTION_REQUIRED') ||
               event.error.message.includes('atomics_error_getting_devlogger_extension') ||
               (event.filename && event.filename.includes('paypal.com')))) {
            event.preventDefault();
            return true;
          }
        });
        
        window.addEventListener('unhandledrejection', function(event) {
          if (event.reason && 
              (event.reason.message?.includes('geolocation') ||
               event.reason.message?.includes('DOMESTIC_TRANSACTION_REQUIRED') ||
               event.reason.message?.includes('atomics_error_getting_devlogger_extension'))) {
            event.preventDefault();
            return true;
          }
        });
      })();
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
